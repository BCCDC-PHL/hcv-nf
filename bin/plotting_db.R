#!/usr/bin/env Rscript
args = commandArgs(trailingOnly=TRUE)

# Script to generate coverage plots

# Load packages

library(tidyverse)
library(ggplot2)
library(scales)
library(dplyr)

# Read in data
# Uses a coverage file, generated by samtools depth [CID_alignment_filtered_sorted.bam]
# renames into segment, position depth,
# then splits out the segment to extract the segment name
filename = args[1]
accession = strsplit(filename,"_")[[1]][1]

coverage <- read_tsv(file = args[1],
                       col_names=F) %>%
  rename(segment = X1,
         position = X2,
         depth = X3) 

coverage = coverage %>% group_by(position) %>% summarise(total_depth = sum(depth))
p = ggplot(coverage, aes(x=position, y=total_depth)) +
  geom_point(colour="dark blue", size=1, shape=20, alpha=1/3) +
  scale_y_continuous(trans = scales::log10_trans(), breaks = scales::trans_breaks("log10", function(x) 10^x))

ggsave(plot = p, filename = paste0(accession, "_db_depth_plots.png"), device = "png", width = 8, units = "in")