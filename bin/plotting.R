#!/usr/bin/env Rscript
args = commandArgs(trailingOnly=TRUE)

# Script to generate coverage plots

# Load packages

library(tidyverse)
library(ggplot2)
library(scales)

# Read in data
# Uses a coverage file, generated by samtools depth [CID_alignment_filtered_sorted.bam]
# renames into segment, position depth,
# then splits out the segment to extract the segment name

coverage <- read_tsv(file = args[1],
                       col_names=F) %>%
  rename(segment = X1,
         position = X2,
         depth = X3) 

coverage$contig = unlist(lapply(coverage[,1]$segment, function(i){
  strsplit(i,"\\|")[[1]][1]
}))


coverage$segment <- gsub("^_R_","",coverage$segment)
coverage$segment <- gsub("-","o",coverage$segment)

coverage <- coverage %>%
  separate(segment, into= c("Accession", "ignore1", "ignore2","amplicon", "segment_name", "subtype", "seg_length"))



Accession <- coverage %>%
  distinct(Accession)
#sample_id <- strsplit(coverage[1,]$segment,'_')[[1]][1]

coverage$contig <- paste0(coverage$amplicon,"_",coverage$contig)

p <- coverage %>%
  ggplot(aes(x = position, y = depth))+
  geom_line()+
  labs(title = paste0(Accession))+
  scale_y_log10(labels=comma)+
  facet_wrap(~ contig, ncol = 1)


contigs <- unique(coverage[,c("amplicon","contig")])

direction <- data.frame(amplicon = c("core","core", "ns5b","ns5b"),
                        direction = c("forward","reverse","forward","reverse"))

rect <- merge(contigs,direction, by = "amplicon")

rect$xmin <- ifelse(rect$amplicon == "core" & rect$direction == "forward", 0 , 
                    ifelse(rect$amplicon == "core" & rect$direction == "reverse",383,
                           ifelse(rect$amplicon == "ns5b" & rect$direction =="forward",0,
                                  ifelse(rect$amplicon =="ns5b" & rect$direction =="reverse",365,NA))))


rect$xmax <- ifelse(rect$amplicon == "core" & rect$direction == "forward", 24 , 
                    ifelse(rect$amplicon == "core" & rect$direction == "reverse",403,
                           ifelse(rect$amplicon == "ns5b" & rect$direction =="forward",23,
                                  ifelse(rect$amplicon =="ns5b" & rect$direction =="reverse",388,NA))))

rect$ymin = 0
rect$ymax = 2



p_final <-  p + geom_rect(data = rect,
                          aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax, fill=direction),
                          alpha = 0.5,
                          inherit.aes = FALSE) + theme(legend.position="none") +
  scale_fill_manual(values = c("forward"="blue","reverse"="red"))




ggsave(plot = p_final, filename = paste0(Accession, "_depth_plots.png"), device = "png", width = 8, units = "in")


