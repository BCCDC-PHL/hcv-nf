#!/usr/bin/env Rscript
args = commandArgs(trailingOnly=TRUE)

# Script to generate coverage plots

# Load packages

library(tidyverse)
library(ggplot2)
library(scales)

# Read in data
# Uses a coverage file, generated by samtools depth [CID_alignment_filtered_sorted.bam]
# renames into segment, position depth,
# then splits out the segment to extract the segment name

coverage <- read_tsv(file = args[1],
                       col_names=F) %>%
  rename(segment = X1,
         position = X2,
         depth = X3) 

sample_id <- strsplit(coverage[1,]$segment,'_')[[1]][1]
         
coverage <- coverage %>%
  separate(segment, into= c("Accession", "ignore1", "ignore2", "ignore3", "segment_name", "subtype", "seg_length"))


Accession <- coverage %>%
  distinct(Accession)


# Plot coverage:
# Use a line-plot, with x-axis as position and depth on the y-axis
# Facet-wrap by segment_name and subtype - hopefully this will grab both when there is more than one 
# subtype - otherwise it will merge them all together, which we do not want.
# Use a log10 transform on the y-axis to allow better visualiztion of the range of depths we are likel to see
# (this was done on ncov tools output)
# output as a pdf
p <- coverage %>%
  ggplot(aes(x = position, y = depth))+
  geom_line()+
  labs(title = Accession)+
  scale_y_log10(labels=comma)+
  facet_wrap(vars(segment_name, subtype), ncol = 1)
  


ggsave(plot = p, filename = paste0(sample_id, "_depth_plots.pdf"), device = "pdf", width = 8, units = "in")

  